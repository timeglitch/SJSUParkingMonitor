<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SJSU Parking Garage Fullness</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    h1 { text-align: center; }
    p { text-align: center; }
    #chart-container { width: 90vw; max-width: 900px; margin: 0 auto; background: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    #controls { text-align: center; margin-bottom: 1em; }
    select { font-size: 1em; padding: 0.3em 1em; }
  </style>
</head>
<body>
  <h1>SJSU Parking Garage Usage History</h1>
  <div id="controls">
    <label for="rangeSelect">Show:</label>
    <select id="rangeSelect">
      <option value="today">Today</option>
      <option value="lastweek">This Day Last Week</option>
      <option value="week">Past 7 Days</option>
      <option value="month">Past 30 Days</option>
    </select>
  </div>
  <div id="chart-container">
    <canvas id="garageChart"></canvas>
  </div>
  <p>Made by Frank Zhang. <a target="_blank"href="https://github.com/timeglitch/SJSUParkingMonitor">GitHub</a></p>
  <script>
    let allData = [];
    let chart;
    let labels, south, west, north, southCampus;

    function getRangeBounds(range) {
      const now = new Date();
      let start, end;
      if (range === "today") {
        start = new Date(now);
        start.setHours(0,0,0,0);
        end = new Date(now);
        end.setHours(23,59,59,999);
      } else if (range === "lastweek") {
        start = new Date(now);
        start.setDate(start.getDate() - 7);
        start.setHours(0,0,0,0);
        end = new Date(now);
        end.setDate(end.getDate() - 7);
        end.setHours(23,59,59,999);
      } else if (range === "week") {
        start = new Date(now);
        start.setDate(start.getDate() - 6);
        start.setHours(0,0,0,0);
        end = new Date(now);
        end.setHours(23,59,59,999);
      } else if (range === "month") {
        start = new Date(now);
        start.setDate(start.getDate() - 29);
        start.setHours(0,0,0,0);
        end = new Date(now);
        end.setHours(23,59,59,999);
      }
      return {start, end};
    }

    function filterData(range) {
      const {start, end} = getRangeBounds(range);
      // Filter data
      return allData.filter(row => {
        const t = new Date(row.timestamp);
        return t >= start && t <= end;
      });
    }

    function updateChart(range) {
      const {start, end} = getRangeBounds(range);
      const filtered = filterData(range);
      const filteredLabels = filtered.map(row => row.timestamp);
      const filteredSouth = filtered.map(row => Number(row["South"]));
      const filteredWest = filtered.map(row => Number(row["West"]));
      const filteredNorth = filtered.map(row => Number(row["North"]));
      const filteredSouthCampus = filtered.map(row => Number(row["South Campus"]));
      // Update chart data
      chart.data.labels = filteredLabels;
      chart.data.datasets[0].data = filteredSouth;
      chart.data.datasets[1].data = filteredWest;
      chart.data.datasets[2].data = filteredNorth;
      chart.data.datasets[3].data = filteredSouthCampus;
      // Set x-axis min/max to full day(s)
      chart.options.scales.x.min = start;
      chart.options.scales.x.max = end;
      chart.update();
    }

    fetch('garage_status_log.json')
      .then(response => response.json())
      .then(data => {
        allData = data;
        // Default to "today"
        const {start, end} = getRangeBounds("today");
        const filtered = filterData("today");
        labels = filtered.map(row => row.timestamp);
        south = filtered.map(row => Number(row["South"]));
        west = filtered.map(row => Number(row["West"]));
        north = filtered.map(row => Number(row["North"]));
        southCampus = filtered.map(row => Number(row["South Campus"]));

        const ctx = document.getElementById('garageChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              { label: 'South', data: south, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: false, tension: 0.2 },
              { label: 'West', data: west, borderColor: '#2980b9', backgroundColor: 'rgba(41,128,185,0.1)', fill: false, tension: 0.2 },
              { label: 'North', data: north, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: false, tension: 0.2 },
              { label: 'South Campus', data: southCampus, borderColor: '#f39c12', backgroundColor: 'rgba(243,156,18,0.1)', fill: false, tension: 0.2 }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Garage Usage (%) Over Time' }
            },
            scales: {
              y: { min: 0, max: 100, title: { display: true, text: 'Usage (%)' } },
              x: {
                title: { display: true, text: 'Time' },
                type: 'time',
                time: {
                  unit: 'hour',
                  displayFormats: { hour: 'HH:mm', day: 'yyyy-MM-dd' },
                  minUnit: 'hour',
                  tooltipFormat: 'yyyy-MM-dd HH:mm:ss'
                },
                min: start,
                max: end,
                ticks: {
                  source: 'auto',
                  autoSkip: true,
                  maxTicksLimit: 24
                }
              }
            }
          }
        });

        document.getElementById('rangeSelect').addEventListener('change', function() {
          updateChart(this.value);
        });
      });
  </script>
</body>
</html>
