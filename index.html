<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SJSU Parking Garage Fullness</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    h1 { text-align: center; }
    p { text-align: center; }
    #chart-container { width: 90vw; max-width: 900px; margin: 0 auto; background: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    #controls { text-align: center; margin-bottom: 1em; }
    select { font-size: 1em; padding: 0.3em 1em; }
  </style>
</head>
<body>
  <h1>SJSU Parking Garage Usage History</h1>
  <div id="controls">
    <label for="rangeSelect">Show:</label>
    <select id="rangeSelect">
      <option value="today">Today</option>
      <option value="lastweek">This Day Last Week</option>
      <option value="week">Past 7 Days</option>
      <option value="month">Past 30 Days</option>
    </select>
    <button id="backBtn">&lt; Back</button>
    <button id="forwardBtn">Forward &gt;</button>
  </div>
  <div id="chart-container">
    <canvas id="garageChart"></canvas>
  </div>
  <p>Last updated from <a href="https://sjsuparkingstatus.sjsu.edu/">SJSU Parking Status</a> at <span id="last-updated-time"></span><br>
  Made by Frank Zhang. <a target="_blank"href="https://github.com/timeglitch/SJSUParkingMonitor">GitHub</a></p>
  <script>
    let allData = [];
    let chart;
    let labels, south, west, north, southCampus;
    let currentRange = "today";
    let offset = 0; // 0 = today, -1 = previous, +1 = next

    function getRangeBounds(range, offset=0) {
      const now = new Date();
      let start, end;
      if (range === "today") {
        start = new Date(now);
        start.setDate(start.getDate() + offset);
        start.setHours(0,0,0,0);
        end = new Date(start);
        end.setHours(23,59,59,999);
      } else if (range === "lastweek") {
        start = new Date(now);
        start.setDate(start.getDate() - 7 + offset);
        start.setHours(0,0,0,0);
        end = new Date(start);
        end.setHours(23,59,59,999);
      } else if (range === "week") {
        start = new Date(now);
        start.setDate(start.getDate() - 6 + offset * 7);
        start.setHours(0,0,0,0);
        end = new Date(start);
        end.setDate(end.getDate() + 6);
        end.setHours(23,59,59,999);
      } else if (range === "month") {
        start = new Date(now);
        start.setDate(start.getDate() - 29 + offset * 30);
        start.setHours(0,0,0,0);
        end = new Date(start);
        end.setDate(end.getDate() + 29);
        end.setHours(23,59,59,999);
      }
      return {start, end};
    }

    function filterData(range, offset=0) {
      const {start, end} = getRangeBounds(range, offset);
      return allData.filter(row => {
        const t = new Date(row.timestamp);
        return t >= start && t <= end;
      });
    }

    function updateChart(range, offset=0) {
      const {start, end} = getRangeBounds(range, offset);
      const filtered = filterData(range, offset);
      const filteredLabels = filtered.map(row => row.timestamp);
      const filteredSouth = filtered.map(row => Number(row["South"]));
      const filteredWest = filtered.map(row => Number(row["West"]));
      const filteredNorth = filtered.map(row => Number(row["North"]));
      const filteredSouthCampus = filtered.map(row => Number(row["South Campus"]));
      chart.data.labels = filteredLabels;
      chart.data.datasets[0].data = filteredSouth;
      chart.data.datasets[1].data = filteredWest;
      chart.data.datasets[2].data = filteredNorth;
      chart.data.datasets[3].data = filteredSouthCampus;
      chart.options.scales.x.min = start;
      chart.options.scales.x.max = end;
      // Dynamically set unit for x-axis
      if (range === "today" || range === "lastweek") {
        chart.options.scales.x.time.unit = 'hour';
        chart.options.scales.x.ticks.maxTicksLimit = 24;
      } else if (range === "week") {
        chart.options.scales.x.time.unit = 'day';
        chart.options.scales.x.ticks.maxTicksLimit = 14;
      } else {
        chart.options.scales.x.time.unit = 'day';
        chart.options.scales.x.ticks.maxTicksLimit = 30;
      }
      chart.update();

      // Disable/enable forward button
      const lastDataTime = allData.length > 0 ? new Date(allData[allData.length - 1].timestamp) : null;
      const endTime = end;
      const forwardBtn = document.getElementById('forwardBtn');
      if (lastDataTime && endTime >= lastDataTime) {
        forwardBtn.disabled = true;
      } else {
        forwardBtn.disabled = false;
      }
    }

    fetch('garage_status_log.json')
      .then(response => response.json())
      .then(data => {
        allData = data;

        // Update last updated time
        if (allData.length > 0) {
          const lastTimestamp = allData[allData.length - 1].timestamp;
          document.getElementById('last-updated-time').textContent = new Date(lastTimestamp).toLocaleString();
        } else {
          document.getElementById('last-updated-time').textContent = "No data available";
        }
        // Default to "today"
        const {start, end} = getRangeBounds("today");
        const filtered = filterData("today");
        labels = filtered.map(row => row.timestamp);
        south = filtered.map(row => Number(row["South"]));
        west = filtered.map(row => Number(row["West"]));
        north = filtered.map(row => Number(row["North"]));
        southCampus = filtered.map(row => Number(row["South Campus"]));

        const ctx = document.getElementById('garageChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              { label: 'South', data: south, borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: false, tension: 0.2 },
              { label: 'West', data: west, borderColor: '#2980b9', backgroundColor: 'rgba(41,128,185,0.1)', fill: false, tension: 0.2 },
              { label: 'North', data: north, borderColor: '#27ae60', backgroundColor: 'rgba(39,174,96,0.1)', fill: false, tension: 0.2 },
              { label: 'South Campus', data: southCampus, borderColor: '#f39c12', backgroundColor: 'rgba(243,156,18,0.1)', fill: false, tension: 0.2 }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Garage Usage (%) Over Time' }
            },
            scales: {
              y: { min: 0, max: 100, title: { display: true, text: 'Usage (%)' } },
              x: {
                title: { display: true, text: 'Time' },
                type: 'time',
                time: {
                  unit: 'hour',
                  displayFormats: {
                    hour: 'MMM d HH:mm',    // e.g., Sep 3 14:00
                    day: 'MMM d',           // e.g., Sep 3
                    week: 'MMM d',          // e.g., Sep 3
                    month: 'MMM yyyy'       // e.g., Sep 2025
                  },
                  minUnit: 'hour',
                  tooltipFormat: 'yyyy-MM-dd HH:mm:ss'
                },
                min: start,
                max: end,
                ticks: {
                  source: 'auto',
                  autoSkip: false,
                  maxTicksLimit: 24
                }
              }
            }
          }
        });

        // Ensure forward button is correctly disabled on initial load
        updateChart("today", 0);

        document.getElementById('rangeSelect').addEventListener('change', function() {
          currentRange = this.value;
          offset = 0; // Reset offset when changing range
          updateChart(currentRange, offset);
        });

        document.getElementById('backBtn').addEventListener('click', function() {
          offset--;
          updateChart(currentRange, offset);
        });

        document.getElementById('forwardBtn').addEventListener('click', function() {
          offset++;
          updateChart(currentRange, offset);
        });
      });
  </script>
</body>
</html>
